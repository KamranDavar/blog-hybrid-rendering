import { Select, List, Row, Col } from "antd";
import type {
  GetServerSideProps,
  InferGetServerSidePropsType,
  NextPage,
} from "next";
import Head from "next/head";
import { useRouter } from "next/router";
import { usePosts } from "../logic/hooks/posts";
import { useUsers } from "../logic/hooks/users";
import { getPosts } from "../logic/services/posts";
import { dehydrate, QueryClient, useQuery } from "react-query";
import { post, user } from "../logic/types";
import { LoadingOutlined } from "@ant-design/icons";

const Home: NextPage = ({}: InferGetServerSidePropsType<
  typeof getServerSideProps
>) => {
  const router = useRouter();
  const { query } = router;
  const posts = usePosts(query);
  const users = useUsers();

  if (posts.isLoading) {
    return <LoadingOutlined />;
  }
  return (
    <div className="home">
      <Head>
        <title>hybrid-rendering</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Row className="action">
        <Col xs={24} md={12} lg={4} className="p-25">
          <Select
            className="width100"
            onChange={(value) => {
              router.replace(
                {
                  pathname: "/",
                  query: { userId: value },
                },
                undefined,
                { shallow: true }
              );
            }}
            placeholder="filter by author"
          >
            {users?.data?.map((item: user, index) => (
              <Select.Option key={index} value={item.id}>
                {item.name}
              </Select.Option>
            ))}
          </Select>
        </Col>
      </Row>
      <section className="album">
        <List
          dataSource={posts?.data}
          renderItem={(item: post) => (
            <List.Item>
              <List.Item.Meta
                title={item.title}
                description={<span>{item.body}</span>}
              />
            </List.Item>
          )}
        />
      </section>
    </div>
  );
};
export const getServerSideProps: GetServerSideProps = async (context) => {
  const queryClient = new QueryClient();
  await queryClient.prefetchQuery(["posts", context.query], getPosts);

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
    },
  };
};

export default Home;
